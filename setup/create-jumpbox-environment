# Create Jumpbox Environment

The Jumpbox is a virtual machine deployed in a workload VNet (spoke) that allows secure administrative access to resources in private networks.

In this repository, the Jumpbox will primarily be used to access:

- PostgreSQL databases deployed in private VNets (Oracle ‚Üí PostgreSQL migrations)
- Any other private resources that do not have a public IP
- Azure CLI, PowerShell, and database management tools to manage workloads securely

> ‚ö†Ô∏è Note: The Jumpbox should not host production workloads. Its purpose is to provide controlled access to private network resources.


‚ö†Ô∏è **Note:** Replace placeholder values like `<your-subscription-id>` with your own before running the commands.

---

### Step 1: Set your subscription

```powershell
# Set your subscription ID
$subscriptionId="<your-subscription-id>"

# Set the Azure subscription context
az account set --subscription $subscriptionId
```

üí° Note:
The $subscriptionId variable stores your Azure subscription.
By using az account set, all future CLI commands will run under this subscription context.

### Step 2: Define general variables

```powershell
# Variables
$location="westus3"
$resourceGroup="rg-jumpbox"
$vnet="vnet-jumpbox"
$subnet="subnet-jumpbox01"
$subnetSecurity="nsg-subnet-jumpbox01"
```

üí° Note:
Defining variables at the top helps make your scripts reusable.
You can change the region or naming convention once here, and all following commands will automatically use those values.

### Step 3: Create a Resource Group for the jumpbox

```powershell
# Create a resource group
az group create --name $resourceGroup --location $location
```

### Step 4: Create the Jumpbox Virtual Network and Subnet

```powershell
# Create a virtual network with a subnet
az network vnet create `
  --resource-group $resourceGroup `
  --name $vnet `
  --address-prefix 10.1.0.0/16 `
  --subnet-name $subnet `
  --subnet-prefix 10.1.0.0/24
  --location $location
```

### Step 5: Create a Network Security Group (NSG) and attach it to the subnet

```powershell
# Create a network security group
az network nsg create `
  --resource-group $resourceGroup `
  --name $subnetSecurity
  --location $location

# Attach network security group to virtual network subnet
az network vnet subnet update `
  --resource-group $resourceGroup `
  --vnet-name $vnet `
  --name $subnet `
  --network-security-group $subnetSecurity
```

### Step 6: Peer spoke vnets to hub

#### Peer vnet-jumpbox - vnet-hub

```powershell
# Variables
$hubResourceGroup="rg-hub"
$hubVNet="vnet-hub"
```

```powershell
az network vnet peering create `
  --name jumpbox-to-hub `
  --resource-group $resourceGroup `
  --vnet-name $vnet `
  --remote-vnet "/subscriptions/$subscriptionId/resourceGroups/$hubResourceGroup/providers/Microsoft.Network/virtualNetworks/$hubVNet" `
  --allow-vnet-access

az network vnet peering create `
  --name hub-to-jumpbox `
  --resource-group rg-hub `
  --vnet-name vnet-hub `
  --remote-vnet "/subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.Network/virtualNetworks/$vnet" `
  --allow-vnet-access  
```

### Step 7: Create a public IP and a network interface to be used by JumpboxVM01 Virtual Machine

```powershell
# Variables
$publicIP="pip-JumpboxVM01"
$networkInterface="nic-JumpboxVM01"
```

```powershell
# Create a public IP
az network public-ip create `
  --resource-group $resourceGroup `
  --name $publicIP `
  --sku Standard `
  --allocation-method Static `
  --location $location
```

```powershell
# Create a network interface
az network nic create `
  --resource-group $resourceGroup `
  --name $networkInterface `
  --vnet-name $vnet `
  --subnet $subnet `
  --network-security-group $subnetSecurity `
  --public-ip-address $publicIP `
  --location $location
```

### Step 8: Link JumpboxVM01's VNet to the DNS zone

Linking JumpboxVM01 Virtual Machine's VNet to the private DNS zone is a critical step for enabling private name resolution of Azure PaaS services like your PostgreSQL Flexible Server. 

Private DNS Zone hs veen created in hub resource group.

```powershell
# Variables
$hubResourceGroup="rg-hub"
$hubVNet="vnet-hub"
```

```powershell
# Link the VNet to the Private DNS Zone
az network private-dns link vnet create `
  --resource-group $hubResourceGroup `
  --zone-name privatelink.postgres.database.azure.com `
  --name link-to-vnet-jumpbox `
  --virtual-network "/subscriptions/$subscriptionId/resourceGroups/$resourceGroup/providers/Microsoft.Network/virtualNetworks/$vnet" `
  --registration-enabled false
```

### Step 9: Create a jumpbox vm


The Jumpbox VM is a small, secure virtual machine deployed in its own dedicated VNet, which is peered to hub VNet and and will be peered to other Vnets like the PostgreSQL VNet.

This design allows the Jumpbox to securely connect to private PostgreSQL servers and other workloads, while still leveraging the shared services (like DNS and monitoring) hosted in the hub.

It serves as a central administrative access point for performing management, migration, and troubleshooting tasks without exposing backend databases to the internet.

Typical use cases include:

- Installing and running VS Code or other migration tools (e.g., Oracle ‚Üí PostgreSQL)
- Connecting securely to private PostgreSQL databases via internal IPs
- Using Azure CLI or PowerShell for workload provisioning and management
- Validating network connectivity across VNets
- Acting as a shared administrative VM for various Azure database workloads

üí° Note:

- The Jumpbox VNet should be peered to both the hub VNet (for shared services) and workload VNets (for direct connectivity).
- Use NSGs, Just-in-Time (JIT) VM access, or Azure Bastion to secure RDP access.
- The Jumpbox should remain lightweight and used only for administrative or testing tasks.

‚ö†Ô∏è **Note:** Replace placeholder values like `<your-admin-username>` and `<your-admin-password>` with your own before running the commands.

```powershell
# Variables
$vmName="JumpboxVM01"
$osDisk="disk1-JumpboxVM01"
```

```powershell
# Create the virtual machine
az vm create `
  --resource-group $resourceGroup `
  --name $vmName `
  --location $location `
  --nics $networkInterface `
  --image Win2022Datacenter `
  --size Standard_B2ms `
  --admin-username <your-admin-username> `
  --admin-password '<your-admin-password>' `
  --os-disk-name $osDisk
```  

### Step 10: Allow RDP Access to the Jumpbox

```powershell
# Variables
$rdpRuleName = "AllowRDP"
$sourceIP = "<your-home-or-office-public-ip>/32"   # Replace with your IP address
$priority = 100  # Lower number = higher priority
```

```powershell
# Create NSG rule to allow RDP
az network nsg rule create `
  --resource-group $resourceGroup `
  --nsg-name $subnetSecurity `
  --name $rdpRuleName `
  --priority $priority `
  --protocol Tcp `
  --source-address-prefixes $sourceIP `
  --destination-port-ranges 3389 `
  --description "Allow RDP access to Jumpbox from trusted IP"
```

### Step 11: Install VS Code in JumpboxVM01

  1. Go to the official download page from your jumpbox VM:
      https://code.visualstudio.com/download
  2. Download the "System Installer" for Windows:
      Look for: "Windows: System Installer"
      User Installer: Installs VS Code only for the current user
      System Installer: Installs VS Code for all users on the system
  3. Run the installer as Administrator:
      This will install VS Code for all users on the VM
  4. Complete the installation:
      Accept defaults
      Enable 
        - Create a desktop icon
        - Add "Open with Code" action to Windows Explorer file context menu
        - Add "Open with Code" action to Windows Explorer directory context menu
        - Register Code as an editor for supported file types
        - Add to PATH

### Step 12: Install VS Code PostgreSQL extension

- Open VS Code
- Go to Extensions View (Ctrl+Shift+X)
- Click the ... menu ‚Üí Install from VSIX...
- Select the downloaded .vsix file (copied the file in JumpboxVM01 to C:\data\Extensions\VSCode)
- Restart VS Code (recommended)